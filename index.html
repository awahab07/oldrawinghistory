<!DOCTYPE html>
<html>
	<head>
		<link rel="stylesheet" type="text/css" href="js/dijit/themes/claro/claro.css">
        <link rel="stylesheet" type="text/css" href="js/dojox/grid/resources/claroGrid.css">
        <link rel="stylesheet" type="text/css" href="css/ol.css">
        <link rel="stylesheet" type="text/css" href="css/main.css">

        <!-- OpenLayers 3.0.0-->
        <script type="text/javascript" src="js/ol-debug.js"></script>
        <script teyp="text/javascript" src="js/ol-custom/ol-goog.js"></script>
        <script teyp="text/javascript" src="js/ol-custom/ol-shape.js"></script>
        <script teyp="text/javascript" src="js/ol-custom/ol-interaction-select.js"></script>
        <script teyp="text/javascript" src="js/ol-custom/ol-layer-manipulation.js"></script>
        <script teyp="text/javascript" src="js/ol-custom/ol-interaction-manipulate.js"></script>
        <script teyp="text/javascript" src="js/ol-custom/ol-interaction-draw.js"></script>
        <script teyp="text/javascript" src="js/ol-custom/ol-canvas-manipulatablelayer.js"></script>

        <!-- dojo 1.9 -->
        <script type="text/javascript">
		    dojoConfig= {
		    	isDebug: true,
		        has: {
		            "dojo-firebug": true
		        },
		        parseOnLoad: false,
		        async: true
		    };
		</script>
		<script type="text/javascript" src="js/dojo/dojo.js" data-dojo-config=""></script>

        <script type="text/javascript">
            var layerStore, layerGrid, widgetDebug = null; // For Debugging
            require([
                        "dojo/parser",
                        "dijit/layout/ContentPane",
                        "dijit/layout/BorderContainer",
                        "dijit/registry",
                        "dojo/_base/lang",
                        "dijit/form/NumberTextBox",
                        "dojox/mvc/sync",
                        "dojox/grid/DataGrid",
                        "demo/widget/MapWidget",
                        "demo/stores/LayerFeatureStore",
                        "dojo/data/ObjectStore",
                        "dojo/store/Observable",
                        "dojo/request",
                        "dojo/ready",
                        "dojo/domReady!"
                    ],
                    function(parser, ContentPane, BorderContainer, registry, lang, NumberTextBox, sync, DataGrid, MapWidget, LayerFeatureStore, ObjectStore, Observable, request, ready) {
                        parser.parse();

                        ready(function(){
                            // The Controller Code
                            var mapWidget = registry.byId("mapWidgetId"),
                                mapToolbarWidget = registry.byId("mapToolbarWidgetId"),
                                undoButton = registry.byId("mapUndoButtonId"),
                                redoButton = registry.byId("mapRedoButtonId"),
                                deleteButton = registry.byId("mapDeleteButtonId"),
                                drawPolygonButton = registry.byId("mapPolygonDrawButtonId"),
                                drawArrowButton = registry.byId("mapArrowDrawButtonId"),
                                drawLineArrowButton = registry.byId("mapLineArrowDrawButtonId"),
                                drawRectangleButton = registry.byId("mapRectangleButtonId"),
                                drawFreeHandLineButton = registry.byId("mapFreeHandLineButtonId"),
                                zoomToExtentButton = registry.byId("zoomToExtentButtonId"),
                                paperWidthNumberBox = registry.byId("paperWidthNumberBoxId"),
                                paperHeightNumberBox = registry.byId("paperHeightNumberBoxId"),
                                exportToPngButton = registry.byId("exportToPngButtonId"),
                                exportToJpgButton = registry.byId("exportToJpgButtonId"),
                                mapControlsToolbar = registry.byId("controlsToolbarId");

                            sync(mapWidget, "mapResolution", mapControlsToolbar, "mapViewResolution", sync.from);
                            sync(mapControlsToolbar, "mapResolution", mapWidget, "sliderResolution", sync.from);

                            // Binding Flags
                            sync(mapControlsToolbar, "shouldGrayOut", mapWidget, "shouldGrayOut", sync.from);
                            sync(mapControlsToolbar, "shouldConstrainPanning", mapWidget, "shouldConstrainPanning", sync.from);


                            layerStore = new Observable(new LayerFeatureStore());
                            mapWidget.processLayerStore(layerStore);

                            layerGrid = new DataGrid({
                                store: dataStore = new ObjectStore({objectStore: layerStore}),
                                structure: [
                                    {name:"Layer", field:"title", width: "120px"},
                                    {name:"Visible", field:"visible", width: "50px", type: dojox.grid.cells.Bool, editable: true}
                                ]
                            }, "layerGridDiv"); // make sure you have a target HTML element with this id
                            layerGrid.startup();
                            layerGrid.getRowNode(0).click();

                            layerGrid.on("rowClick", function(evt){
                                layerStore.notify(layerStore.data[evt.rowIndex], layerStore.data[evt.rowIndex].id);
                            });

                            layerGrid.on("rowClick", function(evt){
                                mapWidget.layerRowClicked(evt.rowIndex);
                            });

                            undoButton.on('click', lang.hitch(mapWidget, 'undo'));

                            redoButton.on('click', lang.hitch(mapWidget, 'redo'));

                            deleteButton.on('click', lang.hitch(mapWidget, 'deleteSelectedFeatures'));

                            drawPolygonButton.on('click', lang.hitch(mapWidget, 'activatePolygonDrawing'));

                            drawArrowButton.on('click', lang.hitch(mapWidget, 'activateArrowDrawing'));

                            zoomToExtentButton.on('click', lang.hitch(mapWidget, 'zoomToDocumentExtent'));

                            drawLineArrowButton.on('click', lang.hitch(mapWidget, 'activateLineArrowDrawing'));

                            drawRectangleButton.on('click', lang.hitch(mapWidget, 'activateRectangleDrawing'));

                            drawFreeHandLineButton.on('click', lang.hitch(mapWidget, 'activateFreeHandLineDrawing'));
                            
                            paperWidthNumberBox.on('change', lang.hitch(mapWidget, 'paperWidthChanged'));

                            paperHeightNumberBox.on('change', lang.hitch(mapWidget, 'paperHeightChanged'));

                            exportToPngButton.on('click', lang.hitch(mapWidget, 'exportCanvas', 'image/png'));

                            exportToJpgButton.on('click', lang.hitch(mapWidget, 'exportCanvas', 'image/jpeg'));
                        });

                    });
        </script>
	</head>
	
	<body class="claro">
		
    	<div style="width:100%;height:100%;" id="appLayout" class="demoLayout"
            data-dojo-type="dijit/layout/BorderContainer"
            data-dojo-props="design: 'headline'">
                
            <div style="height:11%"
                 class="edgePanel"
                 data-dojo-type="dijit/layout/ContentPane"
                 data-dojo-props="region: 'top'">

                <!-- Map Controls Toolbar -->
                <div id="controlsToolbarId" data-dojo-type="demo/widget/ControlsToolbar"></div>

            </div>

            <div style="width: 17%" id="leftCol" class="edgePanel"
                 data-dojo-type="dijit/layout/ContentPane"
                 data-dojo-props="region: 'leading', splitter: true">

                <div id="layerGridDiv"></div>
            </div>

                <div class="centerPanel"
                    data-dojo-type="dijit/layout/ContentPane"
                    data-dojo-props="region: 'center'">

                    <div style="width:100%;height:100%;" id="mapLayout" class="demoLayout"
                        data-dojo-type="dijit/layout/BorderContainer"
                        data-dojo-props="design: 'headline'">

                        <div style="width: 32px;" id="mapToolbarColId" class="edgePanel"
                            data-dojo-type="dijit/layout/ContentPane"
                            data-dojo-props="region: 'leading', splitter: false">

                            <div id="mapToolbarWidgetId" data-dojo-attach-point="mapToolbar" data-dojo-type="dijit/Toolbar">
                                <div id="mapUndoButtonId" data-dojo-attach-point="undoButton" data-dojo-type="dijit/form/Button"
                                    data-dojo-props="iconClass:'dijitEditorIcon dijitEditorIconUndo', showLabel:false">Undo</div>

                                <div id="mapRedoButtonId" data-dojo-attach-point="redoButton" data-dojo-type="dijit/form/Button"
                                    data-dojo-props="iconClass:'dijitEditorIcon dijitEditorIconRedo', showLabel:false">Redo</div>

                                <div id="mapDeleteButtonId" data-dojo-attach-point="deleteButton" data-dojo-type="dijit/form/Button"
                                     data-dojo-props="iconClass:'dijitEditorIcon dijitEditorIconDelete', showLabel:false">Delete</div>

                                <div id="mapPolygonDrawButtonId" data-dojo-attach-point="polygonDrawButton" data-dojo-type="dijit/form/Button"
                                    data-dojo-props="iconClass:'dijitEditorIcon drawPolygonToolbarButton', showLabel:false">Draw Polygon</div>

                                <div id="mapArrowDrawButtonId" data-dojo-attach-point="arrowDrawButton" data-dojo-type="dijit/form/Button"
                                     data-dojo-props="iconClass:'dijitEditorIcon drawArrowButton', showLabel:false">Draw Arrow</div>

                                <div id="zoomToExtentButtonId" data-dojo-attach-point="zoomToExtentButton" data-dojo-type="dijit/form/Button"
                                     data-dojo-props="iconClass:'dijitEditorIcon zoomToExtentButton', showLabel:false">Fit to Window</div>

                                <div id="mapLineArrowDrawButtonId" data-dojo-attach-point="lineArrowDrawButton" data-dojo-type="dijit/form/Button"
                                     data-dojo-props="iconClass:'dijitEditorIcon drawLineArrowButton', showLabel:false">Draw Line Arrow</div>
                                
                                <div id="mapRectangleButtonId" data-dojo-attach-point="drawRectangleButton" data-dojo-type="dijit/form/Button"
                                     data-dojo-props="iconClass:'dijitEditorIcon drawRectangleButton', showLabel:false">Draw Rectangle</div>

                                <div id="mapFreeHandLineButtonId" data-dojo-attach-point="drawFreeHandLineButton" data-dojo-type="dijit/form/Button"
                                     data-dojo-props="iconClass:'dijitEditorIcon drawFreeHandLineButton', showLabel:false">Draw Free Hand</div>
                                
                                <div data-dojo-type="dijit/form/DropDownButton" data-dojo-props="iconClass:'dijitEditorIcon paperButton', showLabel:false">
                                    <span>Paper Size</span>
                                    <div data-dojo-type="dijit/TooltipDialog">
                                        <div id="a4PaperSizeButtonId" data-dojo-attach-point="a4PaperSizeButton" data-dojo-type="dijit/form/Button"
                                             data-dojo-props="iconClass:'dijitEditorIcon paperButton', showLabel:true">
                                             A4
                                             <script type="dojo/on" data-dojo-event="click" data-dojo-args="evt">
                                                require(["dijit/registry"], function(registry){
                                                    registry.byId("paperWidthNumberBoxId").set('value', 595);
                                                });
                                            </script>
                                            <script type="dojo/on" data-dojo-event="click" data-dojo-args="evt">
                                                require(["dijit/registry"], function(registry){
                                                    registry.byId("paperHeightNumberBoxId").set('value', 842);
                                                });
                                            </script>
                                        </div>
                                        <br />
                                        <div id="a3PaperSizeButtonId" data-dojo-attach-point="a3PaperSizeButton" data-dojo-type="dijit/form/Button"
                                             data-dojo-props="iconClass:'dijitEditorIcon paperButton', showLabel:true">
                                             A3
                                             <script type="dojo/on" data-dojo-event="click" data-dojo-args="evt">
                                                require(["dijit/registry"], function(registry){
                                                    registry.byId("paperWidthNumberBoxId").set('value', 842);
                                                });
                                            </script>
                                            <script type="dojo/on" data-dojo-event="click" data-dojo-args="evt">
                                                require(["dijit/registry"], function(registry){
                                                    registry.byId("paperHeightNumberBoxId").set('value', 1191);
                                                });
                                            </script>
                                        </div>
                                        <br />
                                        <input id="paperWidthNumberBoxId" type="text"
                                            data-dojo-type="dijit/form/NumberTextBox"
                                            name= "paperWidth"
                                            required="true"
                                            value="595"
                                            style="width: 50px"
                                            data-dojo-props="constraints:{min:1,max:20000,places:0},
                                            invalidMessage:'Please enter a numeric value.',
                                            rangeMessage:'Invalid width.',
                                            intermediateChanges:true" />
                                        x
                                        <input id="paperHeightNumberBoxId" type="text"
                                            data-dojo-type="dijit/form/NumberTextBox"
                                            name= "paperHeight"
                                            required="true"
                                            value="842"
                                            style="width: 50px"
                                            data-dojo-props="constraints:{min:1,max:20000,places:0},
                                            invalidMessage:'Please enter a numeric value.',
                                            rangeMessage:'Invalid height.',
                                            intermediateChanges:true" />

                                    </div>
                                </div>

                                <div data-dojo-type="dijit/form/DropDownButton" data-dojo-props="iconClass:'dijitEditorIcon exportToolbarButton', showLabel:false">
                                    <span>Export</span>
                                    <div data-dojo-type="dijit/TooltipDialog">
                                        <div id="exportToPngButtonId" data-dojo-attach-point="exportPngButton" data-dojo-type="dijit/form/Button"
                                             data-dojo-props="iconClass:'dijitEditorIcon exportToPngButton', showLabel:true">PNG</div>
                                        <br />
                                        <div id="exportToJpgButtonId" data-dojo-attach-point="exportJpgButton" data-dojo-type="dijit/form/Button"
                                             data-dojo-props="iconClass:'dijitEditorIcon exportToJpgButton', showLabel:true">JPEG</div>
                                    </div>
                                </div>

                            </div>

                        </div>

                        <div class="centerPanel"
                            data-dojo-type="dijit/layout/ContentPane"
                            data-dojo-props="region: 'center'">

                            <div id="mapWidgetId" data-dojo-type="demo/widget/MapWidget"
                                data-dojo-props="imageUrl:'img/scenery-800x600.jpg', width:'100%', height:'100%', imageWidth:800, imageHeight:600, minZoom:0, maxZoom:10, zoomFactor:0.5, zoom:1"></div>

                            <div id="offScreenDivId" style="display: none;">
                                <canvas id="hiddenExportCanvasId" style="border:1px solid red;"></canvas>
                            </div>

                        </div>

                    </div>

                </div>
        </div>
        
	</body>
</html>